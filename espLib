-- espLib by Seos

local ESP = {}
ESP.Enabled = false
ESP.Objects = {}

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Create a box ESP for a character
local function createBox(target)
    local box = Drawing.new("Square")
    box.Thickness = 1.5
    box.Color = Color3.fromRGB(0, 255, 0)
    box.Filled = false
    box.Transparency = 1
    box.Visible = false

    ESP.Objects[target] = {
        Box = box,
        Character = target
    }
end

-- Remove ESP from a character
local function removeBox(target)
    if ESP.Objects[target] then
        ESP.Objects[target].Box:Remove()
        ESP.Objects[target] = nil
    end
end

-- Update ESP per frame
local function update()
    for target, data in pairs(ESP.Objects) do
        local char = data.Character
        local hrp = char:FindFirstChild("HumanoidRootPart")
        local head = char:FindFirstChild("Head")

        if hrp and head and ESP.Enabled then
            local rootPos, vis = workspace.CurrentCamera:WorldToViewportPoint(hrp.Position)
            local headPos = workspace.CurrentCamera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
            local scale = (headPos - rootPos).Magnitude

            if vis then
                data.Box.Size = Vector2.new(scale * 2, scale * 3)
                data.Box.Position = Vector2.new(rootPos.X - scale, rootPos.Y - scale * 1.5)
                data.Box.Visible = true
            else
                data.Box.Visible = false
            end
        else
            data.Box.Visible = false
        end
    end
end

-- Main loop
RunService.RenderStepped:Connect(update)

-- Public API
function ESP:Enable()
    self.Enabled = true
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            createBox(plr.Character)
        end
    end
end

function ESP:Disable()
    self.Enabled = false
    for _, obj in pairs(self.Objects) do
        obj.Box.Visible = false
    end
end

-- Auto-track players joining/leaving
Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function(char)
        if ESP.Enabled then
            task.wait(1) -- wait for character to load
            createBox(char)
        end
    end)
end)

Players.PlayerRemoving:Connect(function(plr)
    if plr.Character then
        removeBox(plr.Character)
    end
end)

return ESP
